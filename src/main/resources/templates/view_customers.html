<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Laundry-Quoll</title>

    <!-- Bootstrap core CSS -->
    <link th:href="@{/Resources/dashgumfree_v2/Theme/assets/css/bootstrap.css}" rel="stylesheet">
    <!--external css-->
    <link th:href="@{/Resources/dashgumfree_v2/Theme/assets/font-awesome/css/font-awesome.css}" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" th:href="@{/Resources/dataTables/css/jquery.dataTables.css}">

    <!-- Custom styles for this template -->
    <link th:href="@{/Resources/dashgumfree_v2/Theme/assets/css/style.css}" rel="stylesheet">
    <link th:href="@{/Resources/dashgumfree_v2/Theme/assets/css/style-responsive.css}" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script th:src="@{https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js}"></script>
      <script th:src="@{https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js}"></script>
    <![endif]-->
  </head>

  <body>

  <section id="container" >
      <!-- **********************************************************************************************************************************************************
      TOP BAR CONTENT & NOTIFICATIONS
      *********************************************************************************************************************************************************** -->
      <!--header start-->
      <header class="header black-bg">
              <div class="sidebar-toggle-box">
                  <div class="fa fa-bars tooltips" style="color:white" data-placement="right" data-original-title="Toggle Navigation"></div>
              </div>
            <!--logo start-->
            <a th:href="@{view_orders}" class="logo"><b>COMPLETE WORKWEAR</b></a>
            <!--logo end-->
            <div class="top-menu">
            	<ul class="nav pull-right top-menu">
                    <li><a class="logout" th:href="@{/logout}">Logout</a></li>
            	</ul>
            </div>
        </header>
      <!--header end-->

      <!-- **********************************************************************************************************************************************************
      MAIN SIDEBAR MENU
      *********************************************************************************************************************************************************** -->
      <!--sidebar start-->
      <aside>
          <div id="sidebar"  class="nav-collapse ">
              <!-- sidebar menu start-->
              <ul class="sidebar-menu" id="nav-accordion">

              	  <p class="centered"><img th:src="@{/Resources/dashgumfree_v2/Theme/assets/img/ui-sam.jpg}" class="img-circle" width="60"></a></p>
              	  <h5 class="centered">Office person</h5>

                  <li class="sub-menu">
                      <a th:href="@{javascript:;}" >
                          <i class="fa fa-tasks"></i>
                          <span>Orders</span>
                      </a>
                      <ul class="sub">
                          <li><a  th:href="@{view_orders.html}">View orders</a></li>
                          <li><a  th:href="@{manage_recurring_orders.html}">Manage recurring orders</a></li>
                          <li><a  th:href="@{add_nonrecurring_orders.html}">Add non-recurring orders</a></li>
                      </ul>
                  </li>

                  <li class="sub-menu">
                      <a th:href="@{javascript:;}" >
                          <i class="fa fa-users"></i>
                          <span>Customers</span>
                      </a>
                      <ul class="sub">
                          <li><a  th:href="@{view_customers.html}">View customers</a></li>
                          <li><a  th:href="@{add_new_customer.html}">Add new customer</a></li>
                      </ul>
                  </li>

                  <li class="sub-menu">
                      <a th:href="@{monthly_report.html}">
                          <i class="fa fa-bar-chart-o"></i>
                          <span>Monthly report</span>
                      </a>
                  </li>

              </ul>
              <!-- sidebar menu end-->
          </div>
      </aside>
      <!--sidebar end-->

      <!-- **********************************************************************************************************************************************************
      MAIN CONTENT
      *********************************************************************************************************************************************************** -->
      <!--main content start-->
      <section id="main-content">
          <section class="wrapper site-min-height">
          	<h3><i class="fa fa-angle-right"></i> View customers</h3>

              <div class="row mt" id="tablediv">
                  <div class="col-md-12">
                      <div class="content-panel">
                          <table id="view-customers-table" class="table table-striped table-advance table-hover">
                              <thead>
                              <tr>
                                  <th><i class="fa fa-bullhorn"></i> Name</th>
                                  <th><i class="fa fa-map-marker"></i> Delivery point</th>
                                  <th><i class="fa fa-edit"></i> Status</th>
                                  <th></th>
                              </tr>
                              </thead>
                          </table>
                      </div><!-- /content-panel -->
                  </div><!-- /col-md-12 -->
              </div><!-- /row -->
              
              <div class="row mt" id="detaildiv" style="display: none;">
                <div class="col-lg-12">
                    <div class="form-panel">
                        <h4 class="mb"></h4>
                        <form class="form-horizontal style-form" method="get">
                            <div class="form-group">
                                <label class="col-sm-2 control-label">Company</label>
                                <label class="control-label" id="detailname"></label>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">Delivery point</label>
                                <label class="control-label" id="detailaddress"></label>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">Laundry type</label>
                                <div class="col-sm-6">
	                                <table class="table  table-bordered" id="itemtable">  
									    <tr>  
									        <th style="text-align:left" width="200">Full Name</th>  
									        <th style="text-align:left" width="200">Short Name</th>   
									    </tr>  
									</table>
								</div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">Status</label>
                                <label class="control-label" id="detailstatus"></label>
                            </div>
                            <div class="form-footer" style="text-align:right">
                                <a type="button" class="btn btn-theme" onclick="showTable();">Back</a>
                            </div>
                        </form>
                    </div>
                </div><!-- col-lg-12-->
            </div><!-- /row -->

              <div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel">
				  <div class="modal-dialog" role="document">
				    <div class="modal-content">
				      <div class="modal-header">
				        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				        <h4 class="modal-title" id="editModalTitle">Edit customer</h4>
				      </div>
				      <div class="modal-body">
				        <form>
				          <div class="form-group">
				            <label for="customer-name" class="control-label">Name:</label>
				            <input type="text" class="form-control" id="name" name="name">
				          </div>
				          <div class="form-group">
				            <label for="delivery-point" class="control-label">Delivery point:</label>
				            <input type="text" class="form-control" id="address" name="address">
				          </div>
				          <div class="form-group">
                          	  <label for="laundry-type" class="control-label">Laundry label:</label>
	                           <table class="table  table-bordered" id="para_table">  
								    <tr>  
								        <th style="text-align:center" width="200">Full name</th>  
								        <th style="text-align:center" width="200">Short name</th>  
								        <th style="text-align:center" width="100">Operation</th>  
								    </tr>   
								</table>  
								<div id="addtrdiv" style="float: right;">  
								    <button type="button" class="btn btn-theme btn-xs" onclick="addtr()">Add new label</button>  
								</div>
						  </div>
				          <div class="form-group">
                              <label for="status" class="control-label">Active:</label>
                              <br>
                              <div class="switch switch-square"
                                   data-on-label="<i class=' fa fa-check'></i>"
                                   data-off-label="<i class='fa fa-times'></i>">
                                   <input type="checkbox" checked="checked" id="active" name="active" value=1>
                              </div>
                          </div>
				        </form>
				      </div>
				      <div class="modal-footer">
				        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				        <button type="button" class="btn btn-theme" onclick="updateCustomer();">Confirm</button>
				      </div>
				    </div>
				  </div>
				</div>

		</section><! --/wrapper -->
      </section><!-- /MAIN CONTENT -->

      <!--main content end-->
  </section>

    <!-- js placed at the end of the document so the pages load faster -->
    <script th:src="@{/Resources/dashgumfree_v2/Theme/assets/js/jquery.js}"></script>
    <script th:src="@{/Resources/dashgumfree_v2/Theme/assets/js/bootstrap.min.js}"></script>
    <script th:src="@{/Resources/dashgumfree_v2/Theme/assets/js/jquery-ui-1.9.2.custom.min.js}"></script>
    <script th:src="@{/Resources/dashgumfree_v2/Theme/assets/js/jquery.ui.touch-punch.min.js}"></script>
    <script class="include" type="text/javascript" th:src="@{/Resources/dashgumfree_v2/Theme/assets/js/jquery.dcjqaccordion.2.7.js}"></script>
    <script th:src="@{/Resources/dashgumfree_v2/Theme/assets/js/jquery.scrollTo.min.js}"></script>
    <script th:src="@{/Resources/dashgumfree_v2/Theme/assets/js/jquery.nicescroll.js}" type="text/javascript"></script>


    <!--common script for all pages-->
    <script th:src="@{/Resources/dashgumfree_v2/Theme/assets/js/common-scripts.js}"></script>

	<!--script for this page-->
    <script th:src="@{/Resources/dashgumfree_v2/Theme/assets/js/jquery-ui-1.9.2.custom.min.js}"></script>

	<!--custom switch-->
	<script th:src="@{/Resources/dashgumfree_v2/Theme/assets/js/bootstrap-switch.js}"></script>

	<!--custom tagsinput-->
	<script th:src="@{/Resources/dashgumfree_v2/Theme/assets/js/jquery.tagsinput.js}"></script>

	<!--custom checkbox & radio-->

	<script type="text/javascript" th:src="@{/Resources/dashgumfree_v2/Theme/assets/js/bootstrap-inputmask/bootstrap-inputmask.min.js}"></script>


	<script th:src="@{/Resources/dashgumfree_v2/Theme/assets/js/form-component.js}"></script>

	<!--custom dataTables-->
	<script type="text/javascript" charset="utf8" th:src="@{/Resources/dataTables/js/jquery.dataTables.js}"></script>
    
    <script th:src="@{/js/layer.js}"></script>
  <script>
      var table;
      $(document).ready( function () {
    	  var active;
    	  // get the list of all companies in the system
    	  table = $('#view-customers-table').DataTable( {
              "processing": true,
              "ajax" : function(data, callback, settings) {
                  $.ajax({
                      type: "GET",
                      url: 'company/getAll',
                      cache : false, 
                      dataType: "json",
                      success: function(result) {
                      	callback(result);
                      },
                      error: function(XMLHttpRequest, textStatus, errorThrown) {
                          alert("Failed.");
                      }
                  });
              },
              "columns": [
                  { "data": "name",
                    "render": function (data, type, full, meta) {
                  	  return data;
                    }
                  },
                  { "data": "address" },
                  {
                      "data": "active",
                      "render": function (data, type, full, meta) {
                    	active = data;
                      	if (data == 0) {
                      		return '<span class="label label-danger label-mini">Deactive</span>';
                      	} else {
                      		return '<span class="label label-success label-mini">Active</span>';
                      	}
                      },
                      "bSortable": false
                  },
                  {
                      "data": "id",
                      "render": function (data, type, full, meta) {
                    	  if (active != 0) {
                    		  return '<button class="btn btn-success btn-xs" onclick="showDetail('+data+');"><i class="fa fa-info-circle"></i></button>' +
                            	'<button class="btn btn-primary btn-xs" onclick="editCustomer('+data+');"><i class="fa fa-pencil"></i></button>' +
                            	'<button class="btn btn-danger btn-xs" onclick="deactiveCustomer('+data+');"><i class="fa fa-trash-o "></i></button>';
                    	  } else {
                    		  return '<button class="btn btn-success btn-xs" onclick="activeCustomer('+data+');"><i class="fa fa-check "></i></button>';
                    	  }
                      },
                      "bSortable": false
                  }
              ]
          } );
    	} );
      
      // read date for edit customer window
      function editCustomer(val){
    	var param = "id=" + val;
    	
    	var table = $("#para_table");  
        var tbody = table.children();  
        var trs = tbody.children(); 
        for (var i=1; i<trs.length; i++) {
      	  trs[i].remove();
        }
      	
      	$.ajax({
              type: "GET",
              url: 'company/getOne',
              cache : false,
              data : param,
              dataType: "json",
              success: function(result) {
            	document.getElementById("editModalTitle").value = result.id;
              	document.getElementById("name").value = result.name;
              	document.getElementById("address").value = result.address;
              	if (result.garmentsList != null) {
              		for (var i=0; i<result.garmentsList.length; i++) {
              			addtr(result.garmentsList[i]);
                	}
              	}
              	if (result.active == 0) {
              		document.getElementById("active").checked = "";
              	} else {
              		document.getElementById("active").checked = "checked";
              	}
              },
              error: function(XMLHttpRequest, textStatus, errorThrown) {
                  alert("Search order failed.");
              }
          });
    	  
    	  $('#editModal').modal();
      }
      
      // read data for update customer window
      function updateCustomer() {
    	  var name = $("#name").val();
    	  var address = $("#address").val();
    	  var garments = gettableinfo();
    	  if(name == ""){
          	return layer.msg('Company name can not be empty.', function(){});
          }
    	  if(address == ""){
           	return layer.msg('Company address can not be empty.', function(){});
          }
    	  if(garments == "" || garments == null){
          	return layer.msg('Laundry label can not be empty.', function(){});
          }
    	  
    	  $.ajax({
              cache: true,
              type: "POST",
              url:'company/updateCompany',
              data:JSON.stringify(getParam()),
              dataType:"json",
              contentType : 'application/json;charset=utf-8',
              async: false,
              success: function(data) {
                  if(data=="success"){
                	  layer.msg('Edit success.', {time:800});
                  }else{
                	  layer.msg('Edit fail.');
                  }
              }
          });
    	  
    	  table.ajax.reload();
          $('#editModal').modal('hide');
      }
      
      // deactive a customer with a confiramtion
      function deactiveCustomer(val) {
    	  layer.confirm('Do you want to deactive this customer?', 
	    	{title:'Confirm deactive',
	    		btn: ['Yes','No']}, 
	    	function(){
	   			var param = "id=" + val;
	   			$.ajax({
	   	            cache: true,
	   	            type: "POST",
	   	            url:'company/delete',
	   	            data:param,
	   	            async: false,
	   	            success: function(data) {
	   	                if(data=="success"){
	   	                    layer.msg('Deactive success.', {time:800});
	   	                 	table.ajax.reload();
	   	                }else{
	   	                    layer.msg('Deactive fail.');
	   	                }
	   	            }
	   	        });
	   		}, function(){
	   		  return;
	   		});
      }
      
   	  // active a customer with a confiramtion
      function activeCustomer(val) {
    	  layer.confirm('Do you want to activate this customer?', 
	    	{title:'Confirm delete',
	    		btn: ['Yes','No']}, 
	    	function(){
	   			var param = "id=" + val;
	   			$.ajax({
	   	            cache: true,
	   	            type: "POST",
	   	            url:'company/activate',
	   	            data:param,
	   	            async: false,
	   	            success: function(data) {
	   	                if(data=="success"){
	   	                    layer.msg('Activate success.', {time:800});
	   	                 	table.ajax.reload();
	   	                }else{
	   	                    layer.msg('Activate fail.');
	   	                }
	   	            }
	   	        });
	   		}, function(){
	   		  return;
	   		});
      }
      
      function getParam(){
      	var param={};
      	param.id = document.getElementById("editModalTitle").value;
      	param.name = $("#name").val();
      	param.address = $("#address").val();
      	if (document.getElementById("active").checked == false) {
      		param.active = 0;
      	} else {
      		param.active = 1;
      	}
      	param.garmentsList = gettableinfo();
      	return param;
      }
      
      // show the detail of a customer in the same page
      function showDetail(val) {
    	  var param = "id="+val;
    	  
    	  var table = $("#itemtable");  
          var tbody = table.children();  
          var trs = tbody.children(); 
          for (var i=1; i<trs.length; i++) {
        	  trs[i].remove();
          }
      	
      	$.ajax({
              type: "GET",
              url: 'company/getOne',
              cache : false,
              data : param,
              dataType: "json",
              success: function(result) {
              	document.getElementById("detailname").innerHTML = result.name;
              	document.getElementById("detailaddress").innerHTML = result.address;
              	if (result.active == 0) {
              		document.getElementById("detailstatus").innerHTML = "Deactive";
              	} else {
              		document.getElementById("detailstatus").innerHTML = "Active";
              	}
              	if (result.garmentsList != null) {
              		for (var i=0; i<result.garmentsList.length; i++) {
                		var table = $("#itemtable");
                		var tr= $("<tr>" +  
                	            "<td  style='text-align:left;'>"+result.garmentsList[i].fullname+"</td>" +  
                	            "<td  style='text-align:left;'>"+result.garmentsList[i].shortname+"</td>");  
               	        table.append(tr);
                	}
              	}
              },
              error: function(XMLHttpRequest, textStatus, errorThrown) {
                  alert("Failed.");
              }
          });
      	
    	  document.getElementById("tablediv").style.display="none";
      	  document.getElementById("detaildiv").style.display="";
      }
      
      function showTable() {
      	document.getElementById("tablediv").style.display="";
      	document.getElementById("detaildiv").style.display="none";
      }
      
    //get table infomation  
      function gettableinfo(){ 
          var table = $("#para_table");  
          var tbody = table.children();  
          var trs = tbody.children();  
          var garmentsList = [];
          for(var i=1;i<trs.length;i++){  
              var tds = trs.eq(i).children();  
              var garment = {};
              for(var j=0;j<tds.length;j++){  
                  if(j==0){  
                      if(tds.eq(j).text()==null||tds.eq(j).text()==""){  
                          return null;  
                      }  
                      garment.fullname=tds.eq(j).text();
                  }  
                  if(j==1){  
                      if(tds.eq(j).text()==null||tds.eq(j).text()==""){  
                          return null;  
                      }  
                      garment.shortname=tds.eq(j).text();
                  }  
              }
              garmentsList.push(garment);
          }   
          return garmentsList;
      }  
        
      function tdclick(tdobject){  
          var td=$(tdobject);  
          td.attr("onclick", "");  
          var text=td.text();  
          td.html("");  
          var input=$("<input>");  
          input.attr("value",text);  
          input.bind("blur",function(){  
              var inputnode=$(this);  
              var inputtext=inputnode.val();  
              var tdNode=inputnode.parent();  
              tdNode.html(inputtext);  
              tdNode.click(tdclick);  
              td.attr("onclick", "tdclick(this)");  
          });  
          input.keyup(function(event){  
              var myEvent =event||window.event;  
              var kcode=myEvent.keyCode;  
              if(kcode==13){  
                  var inputnode=$(this);  
                  var inputtext=inputnode.val();  
                  var tdNode=inputnode.parent();  
                  tdNode.html(inputtext);  
                  tdNode.click(tdclick);  
              }  
          });  
        
          td.append(input);  
          var t =input.val();  
          input.val("").focus().val(t);  
        
          td.unbind("click");  
      }  
      function addtr(val){  
          var table = $("#para_table");  
          if (val != null) {
        	  var tr= $("<tr>" +  
                      "<td  style='text-align:center;' onclick='tdclick(this)'>"+val.fullname+"</td>" +  
                      "<td  style='text-align:center;' onclick='tdclick(this)'>"+val.shortname+"</td>" +  
                      "<td  align='center' onclick='deletetr(this)'><button type='button'  class='btn btn-danger btn-xs'>"+"Delete"+"</button></td></tr>");  
          } else {
        	  var tr= $("<tr>" +  
                      "<td  style='text-align:center;' onclick='tdclick(this)'>"+"</td>" +  
                      "<td  style='text-align:center;' onclick='tdclick(this)'>"+"</td>" +  
                      "<td  align='center' onclick='deletetr(this)'><button type='button'  class='btn btn-danger btn-xs'>"+"Delete"+"</button></td></tr>");  
          }
          table.append(tr);  
      }  
      function deletetr(tdobject){  
          var td=$(tdobject);  
          td.parents("tr").remove();  
      }

  </script>

  </body>
</html>
